//! backbone-delta.js 0.2.0, https://github.com/Two-Screen/backbone-delta
//! © 2012 Stéphan Kochen, Angry Bytes. MIT licensed.
(function(){var e,t;typeof require!="undefined"?(e=require("underscore"),t=exports):(e=window._,t=window.BBDelta={}),t.curry=function(t){var n=t.Model,r=t.Collection,s=function(t,r,i){var s=t.attributes,o={},u;i||(i={});if(!r)return t;r instanceof n&&(r=r.attributes),r=e.clone(r);for(u in s)e.has(r,u)||(r[u]=void 0,o[u]=!0);if(!t.set(r,i))return!1;for(u in o)delete s[u];return t},o=function(n,r){r=r?e.clone(r):{};var i=r.success;r.success=function(e,t,o){var u=n.parse(e,o);if(!s(n,u,r))return!1;i&&i(n,e)},r.error=t.wrapError(r.error,n,r);var o=n.sync||t.sync;return o.call(n,"read",n,r)},u=function(t,n,r){var o={},u=[],a=[],f,l;r||(r={}),n=e.isArray(n)?n.slice():[n];for(i=0,length=n.length;i<length;i++){l=n[i]=t._prepareModel(n[i],r);if(!l)throw new Error("Can't add an invalid model to a collection");o[l.id]=!0,(t.get(l.id)?u:a).push(l)}return u.length===0?t.reset(n,r):(f=t.select(function(e){return!o[e.id]}),t.remove(f,r),e.each(u,function(e){var n=t.get(e);s(n,e,r)}),t.add(a,r),t)},a=function(n,r){r=r?e.clone(r):{},r.parse===undefined&&(r.parse=!0);var i=r.success;r.success=function(e,t,s){var o=n.parse(e,s);u(n,o,r),i&&i(n,e)},r.error=t.wrapError(r.error,n,r);var s=n.sync||t.sync;return s.call(n,"read",n,r)};return{resetModel:s,fetchResetModel:o,deltaCollection:u,fetchDeltaCollection:a}},t.extend=function(e,n){n||(n={});var r=t.curry(e),i=e.Model.prototype,s=e.Collection.prototype;i.reset=function(e,t){return r.resetModel(this,e,t)},i.fetchReset=function(e){return r.fetchResetModel(this,e)},s.delta=function(e,t){return r.deltaCollection(this,e,t)},s.fetchDelta=function(e){return r.fetchDeltaCollection(this,e)};if(!n.noPatch){var o=i.fetch;i.fetch=function(e){return e&&e.reset?r.fetchResetModel(this,e):o.call(this,e)};var u=s.fetch;s.fetch=function(e){return e&&e.delta?r.fetchDeltaCollection(this,e):u.call(this,e)}}return e},t.inherit=function(e,n){var r=function(){};r.prototype=e;var i=new r;return i.Model=e.Model.extend(),i.Collection=e.Collection.extend({model:i.Model}),t.extend(i,n)},typeof window!="undefined"&&window.Backbone&&t.extend(window.Backbone)})();