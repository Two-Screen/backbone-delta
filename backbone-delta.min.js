//! backbone-delta.js 0.3.0, https://github.com/Two-Screen/backbone-delta
//! © 2012 Stéphan Kochen, Angry Bytes. MIT licensed.
(function(){var e;typeof require!="undefined"?e=require("underscore"):e=window._;var t=function(t,n){n||(n={});var r=t.Model,s=r.prototype,o=t.Collection,u=o.prototype;s.reset=function(t,n){var i=this.attributes,s={},o;n||(n={});if(!t)return this;t instanceof r&&(t=t.attributes),t=e.clone(t);for(o in i)e.has(t,o)||(t[o]=void 0,s[o]=!0);if(!this.set(t,n))return!1;for(o in s)delete i[o];return this},s.fetchReset=function(n){n=n?e.clone(n):{};var r=this,i=n.success;return n.success=function(e,t,s){if(!r.reset(r.parse(e,s),n))return!1;i&&i(r,e)},n.error=t.wrapError(n.error,r,n),(this.sync||t.sync).call(this,"read",this,n)},u.delta=function(t,n){var r={},s=[],o=[],u,a;n||(n={}),t=e.isArray(t)?t.slice():[t];for(i=0,length=t.length;i<length;i++){a=t[i]=this._prepareModel(t[i],n);if(!a)throw new Error("Can't add an invalid model to a collection");r[a.id]=!0,(this.get(a.id)?s:o).push(a)}return s.length===0?this.reset(t,n):(u=this.select(function(e){return!r[e.id]}),this.remove(u,n),e.each(s,function(e){this.get(e).reset(e,n)},this),this.add(o,n),this)},u.fetchDelta=function(n){n=n?e.clone(n):{},n.parse===undefined&&(n.parse=!0);var r=this,i=n.success;return n.success=function(e,t,s){r.delta(r.parse(e,s),n),i&&i(r,e)},n.error=t.wrapError(n.error,r,n),(this.sync||t.sync).call(this,"read",this,n)};if(!n.noPatch){var a=s.fetch;s.fetch=function(e){return e&&e.reset?this.fetchReset(e):a.call(this,e)};var f=u.fetch;u.fetch=function(e){return e&&e.delta?this.fetchDelta(e):f.call(this,e)}}return t},n=function(e,n){var r=function(){};r.prototype=e;var i=new r;return i.Model=e.Model.extend(),i.Collection=e.Collection.extend({model:i.Model}),t(i,n)},r;typeof require!="undefined"?(r=n(require("backbone")),module.exports=r):(r=n(window.Backbone),window.BBDelta=r),r.extend=t,r.inherit=n})();