//! backbone-delta.js 0.1.2, https://github.com/Two-Screen/backbone-delta
//! © 2012 Stéphan Kochen, Angry Bytes. MIT licensed.
(function(){var e,t;typeof require!="undefined"?(e=require("underscore"),t=exports):(e=window._,t=window.BBDelta={}),t.curry=function(t){var n=t.Model,r=t.Collection,s=function(t,r,i){var s=t.attributes,o={},u;i||(i={});if(!r)return t;r instanceof n&&(r=r.attributes),r=e.clone(r);for(u in s)e.has(r,u)||(r[u]=void 0,o[u]=!0);if(!t.set(r,i))return!1;for(u in o)delete s[u];return t},o=function(n,r){r=r?e.clone(r):{};var i=r.success;r.success=function(e,t,s){var o=r.reset?"reset":"set";if(!n[o](n.parse(e,s),r))return!1;i&&i(n,e)},r.error=t.wrapError(r.error,n,r);var s=n.sync||t.sync;return s.call(n,"read",n,r)},u=function(t,n,r){var s={},o=[],u=[],a,f;r||(r={}),n=e.isArray(n)?n.slice():[n];for(i=0,length=n.length;i<length;i++){f=n[i]=t._prepareModel(n[i],r);if(!f)throw new Error("Can't add an invalid model to a collection");s[f.id]=!0,(t.get(f.id)?o:u).push(f)}return o.length===0?t.reset(n,r):(a=t.select(function(e){return!s[e.id]}),t.remove(a,r),e.each(o,function(e){t.get(e).reset(e,r)}),t.add(u,r),t)},a=function(n,r){r=r?e.clone(r):{},r.parse===undefined&&(r.parse=!0);var i=r.success;r.success=function(e,t,s){var o="reset";r.delta&&(o="delta"),r.add&&(o="add"),n[o](n.parse(e,s),r),i&&i(n,e)},r.error=t.wrapError(r.error,n,r);var s=n.sync||t.sync;return s.call(n,"read",n,r)};return{resetModel:s,fetchModel:o,collectionDelta:u,fetchCollection:a}},t.extend=function(e){var n=t.curry(e),r=e.Model.prototype;r.reset=function(e,t){return n.resetModel(this,e,t)},r.fetch=function(e){return n.fetchModel(this,e)};var i=e.Collection.prototype;i.delta=function(e,t){return n.collectionDelta(this,e,t)},i.fetch=function(e){return n.fetchCollection(this,e)}},typeof window!="undefined"&&window.Backbone&&t.extend(window.Backbone)})();